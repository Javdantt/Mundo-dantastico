<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Dantastico</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,400&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        .font-display { font-family: 'Space Grotesk', sans-serif; }
        .font-mono { font-family: 'Space Grotesk', monospace; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
        .animate-slide-up { animation: slideUp 0.8s ease-out; }
        .tag-cloud-0 { font-size: 0.875rem; opacity: 0.6; }
        .tag-cloud-1 { font-size: 1rem; opacity: 0.7; }
        .tag-cloud-2 { font-size: 1.125rem; opacity: 0.8; }
        .tag-cloud-3 { font-size: 1.25rem; opacity: 0.9; }
        .tag-cloud-4 { font-size: 1.5rem; opacity: 1; }
        .highlight-reading { background-color: rgba(255, 255, 0, 0.2); transition: background-color 0.3s; }
        .comment-highlight { background-color: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding-left: 8px; }
        .audio-playing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body class="bg-[#f4f1ea] text-[#2c2926]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONOS ---
        const Feather = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>;
        const Moon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const Sun = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const PenTool = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>;
        const BookOpen = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>;
        const ChevronLeft = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"></polyline></svg>;
        const Trash2 = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const Save = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const Search = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const X = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Filter = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;
        const Play = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const Pause = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const Volume2 = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>;
        const MessageSquare = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
        const Plus = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;

        // ----------------------------------------------------------------------
        // BIBLIOTECA OFICIAL
        // ----------------------------------------------------------------------
        
        const BIBLIOTECA_OFICIAL = [
            {
                id: 1,
                title: "Humo de Obra",
                author: "Javier Dantas",
                date: "29 Nov 2025",
                image: "https://i.postimg.cc/K8wGL72B/Gemini-Generated-Image-8ndzi78ndzi78ndz.png", 
                content: "Los albañiles tienen en su contratación un derecho no escrito: el de percibir un asado para todos en los hitos importantes durante la obra. Es decir que los obreros trabajan durante la mañana y luego al mediodía compran la carne y todo para hacer un asado en la obra. Esto generalmente sucede los \"viernes de asados\". Entre materiales y la obra en construcción, el fuego se hace presente. El humo recorre habitaciones y pisos del lugar.\n\nEn algunas religiones y creencias populares de Latinoamérica tienen la particularidad de utilizar el humo para espantar los malos espíritus. Sin embargo, un buen día en la obra de un edificio, los obreros habían terminado el llenado de losa y, estando allí el maestro de obra, recibe la pregunta por el asado, quien consulta con el dueño. Pero al desconocer o enfrentarse con esta disquisición, le pareció injusto y decidió no pagar nada. Aún así, los descontentos obreros se propusieron a hacer una colecta para hacer su asado de viernes, como era costumbre con otros patrones. De todos modos, el dueño insistió en que no hagan el asado, por cierto temor a reclamo de pagarlo, que el hecho de cocinar atrase la obra y un poco por envidia.\n\nAl enterarse un sindicalista, se presentó el viernes siguiente al mediodía en el lugar. El representante de la UOCRA observó la negación. Se acercó al dueño y le comunicó amigablemente que existe un convenio colectivo donde él estaba obligado a pagar por el tiempo de cocción de la carne. Además, le sugirió que pague al menos un asado al finalizar la obra, como un incentivo para los trabajadores. El hombre se desentendió de la ley y del \"pago extra\", ya que argumentaba que ya estaba pagando correctamente por el trabajo, ni más ni menos. Pero el sindicalista ya con otro semblante, le dijo que esto lo iba a lamentar y sin dar más explicaciones, se fue. La obra quedó culminada, no hubo un día de asado durante la construcción. Y si bien había quedado perfectamente terminada, las operaciones de preventa comenzaron a cancelarse sin razón alguna. No recibía visitas ni interés alguno. El dueño no comprendía el por qué, se lo atribuyó a una maniobra mafiosa de los obreros o el sindicato mismo, pero nunca pudo probar nada. La construcción completa continúa sin habitarse y el deterioro cada vez más presente. Se dice que algunos vecinos escuchan voces y ven algunas sombras por las noches, como una construcción fantasmagórica y abandonada.",
                tags: ["Relato", "Urbano", "Realismo Mágico"]
            },
            {
                id: 2,
                title: "Ciudad de e-gatos perdidos",
                author: "Javier Dantas",
                date: "18 Ene 2026",
                image: "",
                content: "Adopté un hermoso gato de tres meses. A los nueve o diez meses ya había crecido un tamaño importante. Tan grande se había puesto que al subir a mi regazo al poco tiempo se me dormían las piernas. Se recostaba dado vuelta dejándome libre su hermosa y blanca panza. Me miraba a los ojos que se entrecerraban, sus pupilas rellenaban de negro lo que habitualmente era amarillo. Solía irse a pasear por la medianera y volvía a las pocas horas. Pero un día no volvió. Pasó el día, la semana, el mes y me había resignado a su ausencia. A pesar de haber visitado diferentes casas vecinas, de haber pegado carteles con su mejor foto alrededor de la cuadra. Todo fue en vano porque no tuve noticias. Cuando miraba aquel rincón donde solía dormir por la mañana cuando daba el sol, me entristecía. Me ponía a escribir en la computadora y extrañaba el peso de su cuerpo peludo y suave sobre mí. Escuchaba rechinar algunas puertas y me los confundía con sus maullidos. El sillón permanece quieto con sus mullidos almohadones enrollados. La bolsa de supermercado a lo lejos está inanimada y de cerca está vacía. Me pasaba las tardes confundido.\n\nUna noche volví del trabajo tarde, muy tarde. Crucé el umbral de la puerta de mi departamento y ahí estaba, acostado sobre el sofá mirándome fijo. Mi alegría fue inmensa seguido por la intriga. ¿Dónde había estado? ¿Cómo había sobrevivido tanto tiempo fuera de casa? Y sobre todo, ¿Cómo había logrado entrar? Es un misterio que aún no logro resolver. Pero, ¿qué importaba? Iñaki estaba de nuevo en mi vida.\n\nAl principio por lógicas razones, lo dejaba encerrado. Cada vez que me iba revisaba puertas y ventanas para que no se vuelva a escapar. Pero con el pasar de los días acepté que no era vida para un animal. Así es que dejé la puerta del patio abierta para que pudiera salir a su antojo y trepar por la medianera. Lo extraño es que no volvió a salir.\n\nEmpecé a seguir más sus movimientos: solo se paseaba de un lado a otro dentro de la casa y siempre mirándome a mí. La mayor parte del tiempo adoptaba una posición faraónica. Se acostaba seguido sobre el sol, como recargándose. Cuando me miraba, sus ojos pasaban de ser dos oyuelos negros a una franja finita negra. También noté que dejó de acostarse sobre mí. Su mirada y movimientos parecían maquinales. Estuviera donde estuviera, sea en el baño, estudiando o cocinando, siempre me seguía. Se ponía en pose de descanso, cerca de mí y en una ubicación estratégica como si estudiara mis movimientos.\n\nDe noche me di cuenta que sus ojos se iluminaban. Esto es algo normal para un gato, pero nunca me había pasado que iluminase la habitación. Tampoco me había dado cuenta que su ración de comida hacía días que estaba intacta.",
                tags: ["Relato", "Misterio", "Fantasía Urbana"]
            }
        ];

        // ----------------------------------------------------------------------
        // CÓDIGO DE LA APLICACIÓN
        // ----------------------------------------------------------------------

        const LienzoLiterario = () => {
            const [view, setView] = useState('library'); 
            const [activeText, setActiveText] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [localDrafts, setLocalDrafts] = useState([]);
            const [allTexts, setAllTexts] = useState([...BIBLIOTECA_OFICIAL]);
            
            // --- Estado para filtros y búsqueda ---
            const [selectedTags, setSelectedTags] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            
            // --- Estado para Audiobook ---
            const [isPlaying, setIsPlaying] = useState(false);
            const [playbackRate, setPlaybackRate] = useState(1);
            const [currentParagraph, setCurrentParagraph] = useState(0);
            const [showAudioControls, setShowAudioControls] = useState(false);
            
            // --- Estado para Comentarios ---
            const [comments, setComments] = useState({});
            const [newComment, setNewComment] = useState('');
            const [activeCommentParagraph, setActiveCommentParagraph] = useState(null);
            const [showCommentsPanel, setShowCommentsPanel] = useState(false);
            
            // Referencias
            const speechRef = useRef(null);
            const paragraphRefs = useRef([]);

            useEffect(() => {
                const saved = localStorage.getItem('lienzoDrafts');
                if (saved) { setLocalDrafts(JSON.parse(saved)); }
                
                // Cargar comentarios guardados
                const savedComments = localStorage.getItem('lienzoComments');
                if (savedComments) { setComments(JSON.parse(savedComments)); }
            }, []);

            useEffect(() => {
                setAllTexts([...localDrafts, ...BIBLIOTECA_OFICIAL]);
            }, [localDrafts]);

            // Guardar comentarios en localStorage
            useEffect(() => {
                localStorage.setItem('lienzoComments', JSON.stringify(comments));
            }, [comments]);

            // --- Obtener todos los tags únicos ---
            const allTags = useMemo(() => {
                const tagMap = {};
                allTexts.forEach(text => {
                    text.tags.forEach(tag => {
                        tagMap[tag] = (tagMap[tag] || 0) + 1;
                    });
                });
                return tagMap;
            }, [allTexts]);

            // --- Filtrar textos ---
            const filteredTexts = useMemo(() => {
                return allTexts.filter(text => {
                    const matchesTags = selectedTags.length === 0 || 
                        selectedTags.every(tag => text.tags.includes(tag));
                    
                    const matchesSearch = searchQuery === '' ||
                        text.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        text.content.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        text.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()));
                    
                    return matchesTags && matchesSearch;
                });
            }, [allTexts, selectedTags, searchQuery]);

            // --- Funciones de Audiobook ---
            const speakText = () => {
                if (!activeText) return;
                
                if ('speechSynthesis' in window) {
                    if (speechRef.current) {
                        window.speechSynthesis.cancel();
                    }
                    
                    const paragraphs = activeText.content.split('\n').filter(p => p.trim() !== '');
                    let currentIndex = 0;
                    
                    const speakParagraph = (index) => {
                        if (index >= paragraphs.length) {
                            setIsPlaying(false);
                            setCurrentParagraph(0);
                            return;
                        }
                        
                        setCurrentParagraph(index);
                        
                        // Scroll al párrafo actual
                        if (paragraphRefs.current[index]) {
                            paragraphRefs.current[index].scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                        
                        const utterance = new SpeechSynthesisUtterance(paragraphs[index]);
                        utterance.lang = 'es-ES';
                        utterance.rate = playbackRate;
                        
                        utterance.onend = () => {
                            currentIndex++;
                            speakParagraph(currentIndex);
                        };
                        
                        speechRef.current = utterance;
                        window.speechSynthesis.speak(utterance);
                    };
                    
                    setIsPlaying(true);
                    speakParagraph(currentIndex);
                }
            };

            const stopSpeaking = () => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    setIsPlaying(false);
                    setCurrentParagraph(0);
                }
            };

            const toggleAudio = () => {
                if (isPlaying) {
                    stopSpeaking();
                } else {
                    speakText();
                }
            };

            const changePlaybackRate = (rate) => {
                setPlaybackRate(rate);
                if (isPlaying) {
                    stopSpeaking();
                    setTimeout(speakText, 100);
                }
            };

            // --- Funciones de Comentarios ---
            const addComment = (paragraphIndex) => {
                if (!newComment.trim()) return;
                
                const textId = activeText.id;
                const paragraphKey = `${textId}-${paragraphIndex}`;
                
                setComments(prev => ({
                    ...prev,
                    [paragraphKey]: [...(prev[paragraphKey] || []), {
                        id: Date.now(),
                        text: newComment,
                        date: new Date().toLocaleString(),
                        paragraphIndex
                    }]
                }));
                
                setNewComment('');
                setActiveCommentParagraph(null);
            };

            const deleteComment = (paragraphKey, commentId) => {
                setComments(prev => ({
                    ...prev,
                    [paragraphKey]: prev[paragraphKey].filter(c => c.id !== commentId)
                }));
            };

            const getCommentsForParagraph = (paragraphIndex) => {
                if (!activeText) return [];
                const paragraphKey = `${activeText.id}-${paragraphIndex}`;
                return comments[paragraphKey] || [];
            };

            // --- Funciones generales ---
            const saveDraft = (newText) => {
                const draftWithMeta = {
                    ...newText,
                    id: `draft-${Date.now()}`,
                    isDraft: true,
                    date: new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
                };
                const updatedDrafts = [draftWithMeta, ...localDrafts];
                setLocalDrafts(updatedDrafts);
                localStorage.setItem('lienzoDrafts', JSON.stringify(updatedDrafts));
                setView('library');
            };

            const deleteDraft = (id) => {
                if(window.confirm("¿Eliminar este borrador?")) {
                    const updatedDrafts = localDrafts.filter(t => t.id !== id);
                    setLocalDrafts(updatedDrafts);
                    localStorage.setItem('lienzoDrafts', JSON.stringify(updatedDrafts));
                    if (activeText?.id === id) setView('library');
                }
            };

            const estimatedReadingTime = (text) => {
                const words = text.split(/\s+/).length;
                const minutes = Math.ceil(words / 200);
                return `${minutes} min`;
            };

            const toggleTag = (tag) => {
                if (selectedTags.includes(tag)) {
                    setSelectedTags(selectedTags.filter(t => t !== tag));
                } else {
                    setSelectedTags([...selectedTags, tag]);
                }
            };

            const clearFilters = () => {
                setSelectedTags([]);
                setSearchQuery('');
            };

            const getTagLevel = (tag) => {
                const count = allTags[tag] || 0;
                if (count >= 3) return 4;
                if (count === 2) return 3;
                if (count === 1) return 2;
                return 1;
            };

            // --- Componentes Internos ---

            const Navigation = () => (
                <nav className={`fixed top-0 left-0 w-full z-50 flex justify-between items-center px-6 py-4 border-b transition-colors duration-500 ${darkMode ? 'bg-zinc-900 border-zinc-800 text-zinc-100' : 'bg-[#f4f1ea] border-stone-300 text-stone-800'}`}>
                    <div onClick={() => { setView('library'); clearFilters(); stopSpeaking(); }} className="cursor-pointer flex items-center gap-2 group">
                        <Feather className={`w-5 h-5 transition-transform group-hover:rotate-[-15deg]`} />
                        <h1 className="text-xl font-bold tracking-tighter font-display uppercase">Mundo Dantastico</h1>
                    </div>
                    <div className="flex gap-4 items-center">
                        <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                            {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                        </button>
                        <button onClick={() => setView('composer')} className={`flex items-center gap-2 px-4 py-2 text-sm font-medium border transition-all duration-300 hover:shadow-[3px_3px_0px_0px_currentColor] ${darkMode ? 'border-zinc-700 hover:bg-zinc-800' : 'border-stone-800 hover:bg-white'}`}>
                            <PenTool className="w-4 h-4" />
                            <span className="hidden sm:inline">Nuevo Borrador</span>
                        </button>
                    </div>
                </nav>
            );

            const FilterPanel = () => (
                <div className={`mb-8 p-6 border transition-colors duration-300 ${darkMode ? 'border-zinc-800 bg-zinc-900' : 'border-stone-300 bg-white'}`}>
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-2">
                            <Filter className="w-5 h-5" />
                            <h3 className="font-display font-bold text-lg">Filtrar y Buscar</h3>
                        </div>
                        {(selectedTags.length > 0 || searchQuery) && (
                            <button onClick={clearFilters} className="flex items-center gap-2 font-mono text-xs hover:underline opacity-60 hover:opacity-100">
                                <X className="w-3 h-3" /> LIMPIAR FILTROS
                            </button>
                        )}
                    </div>
                    
                    <div className="mb-6">
                        <div className="relative">
                            <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 ${darkMode ? 'text-zinc-500' : 'text-stone-400'}`} />
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="Buscar por título, contenido o categoría..."
                                className={`w-full pl-10 pr-4 py-3 font-serif border-b focus:outline-none ${darkMode ? 'bg-transparent border-zinc-700 text-zinc-200 placeholder-zinc-500 focus:border-zinc-400' : 'bg-transparent border-stone-300 text-stone-800 placeholder-stone-400 focus:border-stone-600'}`}
                            />
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <h4 className="font-mono text-xs uppercase tracking-widest opacity-50 mb-3">Categorías</h4>
                        <div className="flex flex-wrap gap-2">
                            {Object.keys(allTags).sort().map(tag => {
                                const isSelected = selectedTags.includes(tag);
                                const tagLevel = getTagLevel(tag);
                                return (
                                    <button
                                        key={tag}
                                        onClick={() => toggleTag(tag)}
                                        className={`px-3 py-1.5 font-mono transition-all duration-200 border hover:scale-105 ${darkMode ? 
                                            (isSelected ? 'bg-zinc-200 text-zinc-900 border-zinc-200' : 'border-zinc-700 hover:border-zinc-500') : 
                                            (isSelected ? 'bg-stone-800 text-white border-stone-800' : 'border-stone-300 hover:border-stone-600')
                                        }`}
                                    >
                                        <span className={`tag-cloud-${tagLevel}`}>
                                            {tag} ({allTags[tag]})
                                        </span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                    
                    {selectedTags.length > 0 && (
                        <div className="mb-4">
                            <h4 className="font-mono text-xs uppercase tracking-widest opacity-50 mb-2">Filtrando por:</h4>
                            <div className="flex flex-wrap gap-2">
                                {selectedTags.map(tag => (
                                    <div key={tag} className={`px-2 py-1 font-mono text-xs flex items-center gap-1 ${darkMode ? 'bg-zinc-800 text-zinc-300' : 'bg-stone-200 text-stone-700'}`}>
                                        {tag}
                                        <button onClick={() => toggleTag(tag)} className="hover:opacity-70">
                                            <X className="w-3 h-3" />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    <div className={`text-sm font-mono ${darkMode ? 'text-zinc-400' : 'text-stone-600'}`}>
                        Mostrando {filteredTexts.length} de {allTexts.length} textos
                    </div>
                </div>
            );

            const Library = () => (
                <div className="pt-24 pb-12 px-6 max-w-7xl mx-auto min-h-screen animate-fade-in">
                    <FilterPanel />
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        {filteredTexts.length === 0 ? (
                            <div className={`col-span-full text-center py-16 border ${darkMode ? 'border-zinc-800' : 'border-stone-300'}`}>
                                <p className={`text-lg font-serif ${darkMode ? 'text-zinc-400' : 'text-stone-600'}`}>
                                    No se encontraron textos con los filtros aplicados.
                                </p>
                                <button 
                                    onClick={clearFilters}
                                    className={`mt-4 font-mono text-sm border px-4 py-2 hover:underline ${darkMode ? 'border-zinc-700' : 'border-stone-400'}`}
                                >
                                    VER TODOS LOS TEXTOS
                                </button>
                            </div>
                        ) : (
                            filteredTexts.map((text) => (
                                <div key={text.id} onClick={() => { setActiveText(text); setView('reader'); }} className={`group relative cursor-pointer border p-6 ${text.image ? 'h-[26rem]' : 'h-80'} flex flex-col justify-between transition-all duration-500 hover:-translate-y-2 ${darkMode ? 'border-zinc-800 bg-zinc-900 hover:border-zinc-500' : 'border-stone-300 bg-[#f9f7f1] hover:border-stone-800 hover:shadow-xl'}`}>
                                    {text.isDraft && <div className="absolute top-2 right-2 bg-yellow-200 text-yellow-900 text-[10px] font-mono px-2 py-1 uppercase tracking-wider font-bold z-10">Borrador Privado</div>}
                                    
                                    <div className="flex-1 flex flex-col">
                                        {text.image && (
                                            <div className="w-[calc(100%+3rem)] -mx-6 -mt-6 mb-4 h-48 overflow-hidden border-b border-current opacity-90 group-hover:opacity-100 transition-opacity">
                                                <img src={text.image} alt={text.title} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                                            </div>
                                        )}

                                        <div className="flex justify-between items-start mb-4 mt-2">
                                            <span className="font-mono text-xs opacity-60">{text.date}</span>
                                            <div className="flex flex-wrap gap-1 justify-end">
                                                {text.tags.map(tag => (
                                                    <span key={tag} className={`font-mono text-xs border rounded px-1 opacity-60 border-current ${selectedTags.includes(tag) ? 'opacity-100 font-bold' : ''}`}>
                                                        {tag}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        <h3 className="text-2xl font-serif font-bold leading-tight mb-3 line-clamp-2 group-hover:underline decoration-1 underline-offset-4">{text.title}</h3>
                                        <p className={`font-serif text-lg leading-relaxed line-clamp-3 ${darkMode ? 'text-zinc-400' : 'text-stone-600'}`}>
                                            {searchQuery && text.content.toLowerCase().includes(searchQuery.toLowerCase()) ? (
                                                <>
                                                    ...{text.content.substring(
                                                        Math.max(0, text.content.toLowerCase().indexOf(searchQuery.toLowerCase()) - 50),
                                                        text.content.toLowerCase().indexOf(searchQuery.toLowerCase()) + 100
                                                    )}...
                                                </>
                                            ) : text.content}
                                        </p>
                                    </div>
                                    <div className="flex justify-between items-end border-t border-dashed pt-4 border-current opacity-40 group-hover:opacity-100 transition-opacity mt-4">
                                        <span className="font-mono text-xs">{estimatedReadingTime(text.content)} lectura</span>
                                        <BookOpen className="w-4 h-4" />
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );

            const AudioControls = () => (
                <div className={`fixed bottom-6 right-6 z-40 ${showAudioControls ? 'block' : 'hidden'}`}>
                    <div className={`p-4 border rounded-lg shadow-lg ${darkMode ? 'bg-zinc-900 border-zinc-700' : 'bg-white border-stone-300'}`}>
                        <div className="flex items-center gap-4 mb-4">
                            <button 
                                onClick={toggleAudio}
                                className={`p-3 rounded-full ${isPlaying ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'} ${darkMode ? 'bg-opacity-20' : ''}`}
                            >
                                {isPlaying ? <Pause className="w-6 h-6" /> : <Play className="w-6 h-6" />}
                            </button>
                            <div>
                                <div className="font-mono text-xs opacity-60">VELOCIDAD</div>
                                <div className="flex gap-2">
                                    {[0.5, 0.75, 1, 1.25, 1.5].map(rate => (
                                        <button
                                            key={rate}
                                            onClick={() => changePlaybackRate(rate)}
                                            className={`px-2 py-1 text-xs border ${playbackRate === rate ? 
                                                (darkMode ? 'bg-zinc-700 border-zinc-600' : 'bg-stone-200 border-stone-400') : 
                                                (darkMode ? 'border-zinc-700 hover:border-zinc-600' : 'border-stone-300 hover:border-stone-400')
                                            }`}
                                        >
                                            {rate}x
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                        {isPlaying && (
                            <div className="text-xs font-mono opacity-70">
                                Leyendo párrafo {currentParagraph + 1}
                            </div>
                        )}
                    </div>
                </div>
            );

            const CommentsPanel = () => (
                <div className={`fixed top-24 right-6 w-80 max-h-[calc(100vh-8rem)] overflow-y-auto ${showCommentsPanel ? 'block' : 'hidden'}`}>
                    <div className={`p-4 border rounded-lg shadow-lg ${darkMode ? 'bg-zinc-900 border-zinc-700' : 'bg-white border-stone-300'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-display font-bold">Comentarios</h3>
                            <button 
                                onClick={() => setShowCommentsPanel(false)}
                                className="p-1 hover:opacity-70"
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                        
                        {activeCommentParagraph !== null ? (
                            <div className="mb-4">
                                <textarea
                                    value={newComment}
                                    onChange={(e) => setNewComment(e.target.value)}
                                    placeholder="Escribe tu comentario..."
                                    className={`w-full p-3 border mb-2 ${darkMode ? 'bg-zinc-800 border-zinc-700 text-white' : 'bg-stone-50 border-stone-300'}`}
                                    rows="3"
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => addComment(activeCommentParagraph)}
                                        className="px-4 py-2 bg-blue-600 text-white text-sm hover:bg-blue-700"
                                    >
                                        Guardar
                                    </button>
                                    <button
                                        onClick={() => setActiveCommentParagraph(null)}
                                        className="px-4 py-2 border text-sm hover:bg-gray-100"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        ) : null}
                        
                        <div className="space-y-4">
                            {Object.keys(comments)
                                .filter(key => key.startsWith(activeText?.id + '-'))
                                .map(key => {
                                    const paragraphIndex = parseInt(key.split('-')[1]);
                                    const paragraphComments = comments[key];
                                    
                                    return paragraphComments.map(comment => (
                                        <div key={comment.id} className={`p-3 border rounded ${darkMode ? 'border-zinc-700 bg-zinc-800' : 'border-stone-200 bg-stone-50'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="font-mono text-xs opacity-60">{comment.date}</span>
                                                <button 
                                                    onClick={() => deleteComment(key, comment.id)}
                                                    className="text-xs text-red-500 hover:text-red-700"
                                                >
                                                    Eliminar
                                                </button>
                                            </div>
                                            <p className="text-sm">{comment.text}</p>
                                            <div className="mt-2 text-xs opacity-60">
                                                Párrafo {paragraphIndex + 1}
                                            </div>
                                        </div>
                                    ));
                                })
                            }
                        </div>
                        
                        {Object.keys(comments).filter(key => key.startsWith(activeText?.id + '-')).length === 0 && (
                            <div className={`text-center py-8 ${darkMode ? 'text-zinc-500' : 'text-stone-500'}`}>
                                <MessageSquare className="w-8 h-8 mx-auto mb-2 opacity-40" />
                                <p className="text-sm">No hay comentarios aún</p>
                            </div>
                        )}
                    </div>
                </div>
            );

            const Reader = () => {
                if (!activeText) return null;
                
                const paragraphs = activeText.content.split('\n').filter(p => p.trim() !== '');
                
                return (
                    <div className="min-h-screen pt-24 pb-20 animate-slide-up">
                        <div className={`fixed top-[73px] left-0 h-1 bg-current opacity-20 w-full origin-left`} />
                        
                        {/* Barra de herramientas del lector */}
                        <div className={`fixed top-[73px] left-0 right-0 z-30 py-3 px-6 border-b ${darkMode ? 'bg-zinc-900 border-zinc-800' : 'bg-[#f4f1ea] border-stone-300'}`}>
                            <div className="max-w-3xl mx-auto flex justify-between items-center">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => setView('library')} className="flex items-center gap-2 font-mono text-xs hover:underline opacity-60 hover:opacity-100">
                                        <ChevronLeft className="w-4 h-4" /> VOLVER
                                    </button>
                                    
                                    {/* Botón Audiobook */}
                                    <button 
                                        onClick={() => setShowAudioControls(!showAudioControls)}
                                        className={`flex items-center gap-2 font-mono text-xs px-3 py-1.5 border ${darkMode ? 'border-zinc-700 hover:border-zinc-500' : 'border-stone-400 hover:border-stone-600'} ${isPlaying ? 'audio-playing' : ''}`}
                                    >
                                        <Volume2 className="w-4 h-4" />
                                        {isPlaying ? 'ESCUCHANDO' : 'AUDIOLIBRO'}
                                    </button>
                                    
                                    {/* Botón Comentarios */}
                                    <button 
                                        onClick={() => setShowCommentsPanel(!showCommentsPanel)}
                                        className={`flex items-center gap-2 font-mono text-xs px-3 py-1.5 border ${darkMode ? 'border-zinc-700 hover:border-zinc-500' : 'border-stone-400 hover:border-stone-600'}`}
                                    >
                                        <MessageSquare className="w-4 h-4" />
                                        COMENTARIOS
                                    </button>
                                </div>
                                
                                {activeText.isDraft && (
                                    <button onClick={() => deleteDraft(activeText.id)} className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1 rounded flex items-center gap-2 transition-colors">
                                        <Trash2 className="w-4 h-4" /> <span className="text-xs font-mono">ELIMINAR</span>
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        {/* Controles de Audio */}
                        <AudioControls />
                        
                        {/* Panel de Comentarios */}
                        <CommentsPanel />
                        
                        <div className="max-w-3xl mx-auto px-6 md:px-12 relative pt-16">
                            {activeText.image && (
                                <div className="mb-12 w-full h-64 md:h-96 overflow-hidden border border-current">
                                    <img src={activeText.image} className="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-1000" alt="Portada" />
                                </div>
                            )}

                            <header className="mb-16 text-center">
                                <div className="flex flex-wrap justify-center gap-2 mb-4">
                                    {activeText.tags.map(tag => (
                                        <span key={tag} className="font-mono text-xs tracking-widest uppercase opacity-60 border border-current px-2 py-1">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                                <span className="font-mono text-xs tracking-widest uppercase mb-4 block opacity-60">{activeText.date}</span>
                                <h1 className="text-4xl md:text-6xl font-serif font-bold mb-6 leading-tight">{activeText.title}</h1>
                                <div className="w-12 h-1 bg-current mx-auto opacity-20"></div>
                            </header>
                            
                            <article className={`prose prose-lg md:prose-xl mx-auto font-serif leading-loose ${darkMode ? 'prose-invert text-zinc-300' : 'text-stone-800'}`}>
                                {paragraphs.map((paragraph, idx) => {
                                    const paragraphComments = getCommentsForParagraph(idx);
                                    const hasComments = paragraphComments.length > 0;
                                    
                                    return (
                                        <div 
                                            key={idx} 
                                            ref={el => paragraphRefs.current[idx] = el}
                                            className={`relative mb-6 transition-all duration-300 ${idx === currentParagraph ? 'highlight-reading' : ''} ${hasComments ? 'comment-highlight' : ''}`}
                                        >
                                            <p className={`first-letter:text-5xl first-letter:font-bold first-letter:float-left first-letter:mr-3 first-letter:mt-[-6px] first-letter:font-display ${darkMode ? 'text-zinc-300' : 'text-stone-800'}`}>
                                                {paragraph}
                                            </p>
                                            
                                            {/* Botón para agregar comentario */}
                                            <button
                                                onClick={() => setActiveCommentParagraph(idx)}
                                                className={`absolute -right-10 top-0 opacity-0 hover:opacity-100 transition-opacity p-1 ${darkMode ? 'text-zinc-500 hover:text-zinc-300' : 'text-stone-400 hover:text-stone-600'}`}
                                            >
                                                <Plus className="w-4 h-4" />
                                            </button>
                                            
                                            {/* Mostrar comentarios existentes */}
                                            {hasComments && (
                                                <div className="mt-2 ml-4">
                                                    {paragraphComments.slice(0, 1).map(comment => (
                                                        <div key={comment.id} className={`text-sm p-2 rounded ${darkMode ? 'bg-zinc-800 text-zinc-300' : 'bg-stone-100 text-stone-700'}`}>
                                                            💬 {comment.text}
                                                        </div>
                                                    ))}
                                                    {paragraphComments.length > 1 && (
                                                        <div className={`text-xs mt-1 ${darkMode ? 'text-zinc-500' : 'text-stone-500'}`}>
                                                            +{paragraphComments.length - 1} comentario{paragraphComments.length > 2 ? 's' : ''} más
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </article>
                            
                            <div className="mt-24 pt-12 border-t border-dashed border-current opacity-30 text-center font-mono text-xs">
                                *** FIN DE LA TRANSMISIÓN ***
                            </div>
                        </div>
                    </div>
                );
            };

            const Composer = () => {
                const [title, setTitle] = useState('');
                const [content, setContent] = useState('');
                const [tag, setTag] = useState('');
                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!title || !content) return;
                    saveDraft({ title, content, tags: [tag || 'Sin categoría'] });
                };
                return (
                    <div className="min-h-screen pt-24 px-6 flex justify-center animate-fade-in">
                        <form onSubmit={handleSubmit} className="w-full max-w-2xl">
                            <button type="button" onClick={() => setView('library')} className="mb-8 flex items-center gap-2 font-mono text-xs hover:underline opacity-60 hover:opacity-100">
                                <ChevronLeft className="w-4 h-4" /> CANCELAR
                            </button>
                            <div className="p-6 border border-dashed border-current mb-8 bg-yellow-50 dark:bg-yellow-900/10">
                                <p className="font-mono text-xs opacity-70">
                                    <strong>MODO BORRADOR:</strong> Esto es para escribir ideas rápidas. 
                                    Para publicar oficialmente, recuerda copiar tu texto al código fuente.
                                </p>
                            </div>
                            <div className="space-y-8">
                                <div>
                                    <label className="block font-mono text-xs uppercase tracking-widest opacity-50 mb-2">Título</label>
                                    <input type="text" value={title} onChange={e => setTitle(e.target.value)} placeholder="Título..." className={`w-full text-3xl md:text-5xl font-serif font-bold bg-transparent border-b-2 border-transparent focus:border-current focus:outline-none placeholder-opacity-30 ${darkMode ? 'placeholder-zinc-600' : 'placeholder-stone-400'}`} autoFocus />
                                </div>
                                <div>
                                    <label className="block font-mono text-xs uppercase tracking-widest opacity-50 mb-2">Categoría</label>
                                    <input type="text" value={tag} onChange={e => setTag(e.target.value)} placeholder="Ej. Reflexión" className="w-full font-mono bg-transparent border-b border-dashed border-current focus:outline-none py-2 opacity-80" />
                                </div>
                                <div>
                                    <label className="block font-mono text-xs uppercase tracking-widest opacity-50 mb-4">Contenido</label>
                                    <textarea value={content} onChange={e => setContent(e.target.value)} placeholder="Escribe aquí..." className={`w-full h-96 bg-transparent resize-none font-serif text-lg leading-relaxed focus:outline-none placeholder-opacity-30 ${darkMode ? 'placeholder-zinc-600' : 'placeholder-stone-400'}`} />
                                </div>
                                <div className="flex justify-end pt-6 border-t border-current">
                                    <button type="submit" disabled={!title || !content} className={`flex items-center gap-2 font-mono text-sm uppercase tracking-widest px-8 py-3 border transition-all hover:translate-x-1 disabled:opacity-30 disabled:hover:translate-x-0 ${darkMode ? 'border-zinc-600 hover:bg-zinc-800' : 'border-stone-800 hover:bg-stone-200'}`}>
                                        <Save className="w-4 h-4" /> Guardar Borrador
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                );
            };
            
            return (
                <div className={`min-h-screen transition-colors duration-700 ease-in-out font-sans selection:bg-yellow-200 selection:text-black ${darkMode ? 'bg-zinc-950 text-zinc-200 selection:bg-fuchsia-900 selection:text-white' : 'bg-[#f4f1ea] text-[#2c2926]'}`}>
                    <Navigation />
                    <main>
                        {view === 'library' && <Library />}
                        {view === 'reader' && <Reader />}
                        {view === 'composer' && <Composer />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <div className="font-sans selection:bg-yellow-200 selection:text-black">
                <LienzoLiterario />
            </div>
        );
    </script>
</body>
</html>